image:https://github.com/ncomet/koson/blob/master/image/koson-logo.png["Koson Logo", link="https://github.com/ncomet/koson"]

= Koson

image:https://travis-ci.org/ncomet/koson.svg?branch=master["Build Status", link="https://travis-ci.org/ncomet/koson"]

A concise and lightweight `Kotlin` DSL to build `JSON` objects and render their _String representations_

Requiring no other dependency than `Kotlin`

== DSL

.Kotlin
[source, Kotlin]
----
// for an empty object
obj { }

// for an object
obj {
  "attribute" to 42
  "another" to true
}

// for an empty array
array

// for an array
array["element", 12.345, null]
----

NOTE: Any combination of these elements is possible

== How to use

.Kotlin
[source, Kotlin]
----
val obj = obj {
  "key" to 3.4
  "anotherKey" to array["test", "test2", 1, 2.433, true]
  "nullValue" to null
  "emptyObject" to obj { }
  "emptyArray" to array
  "custom" to Date()
}

println(obj) <1>
println(obj.pretty()) <2>
----

.JSON output
[source, json]
----
<1>
{"key":3.4,"anotherKey":["test","test2",1,2.433,true],"nullValue":null,"emptyObject":{},"emptyArray":[],"custom":"Tue Dec 11 13:14:14 CET 2018"}

<2>
{
  "key": 3.4,
  "anotherKey": [
    "test",
    "test2",
    1,
    2.433,
    true
  ],
  "nullValue": null,
  "emptyObject": {

  },
  "emptyArray": [

  ],
  "custom": "Tue Dec 11 13:14:14 CET 2018"
}
----

.Kotlin
[source, Kotlin]
----
val array = array[
  "example",
  obj {
    "apple" to "pie"
    "key" to 3.14
     "anotherKey" to array["first", "second", 1, 2.433, true]
  }
]

println(array) <1>
println(array.pretty()) <2>
----

.JSON output
[source, json]
----
<1>
["example",{"apple":"pie","key":3.14,"anotherKey":["first","second",1,2.433,true]}]

<2>
[
  "example",
  {
    "apple": "pie",
    "key": 3.14,
    "anotherKey": [
      "first",
      "second",
      1,
      2.433,
      true
    ]
  }
]
----

== Pretty print

When using the `pretty()` method on `obj` or `array`, you can define the number of whitespaces used for tabulation. Default value is `2`.

[source, Kotlin]
----
// "compact", single line mode
obj { ... }

// 2 whitespaces tabulation
obj { ... }.pretty()

// 3 whitespaces tabulation
array[ ... ].pretty(3)
----

== Strong type constraints

* A JSON key (attribute) can only be of `Kotlin` type `String`

[NOTE]
====
In IntelliJ, a compilation error will appear, and code will be flagged as not reachable

image:https://github.com/ncomet/koson/blob/master/image/koson-typing.png["Koson Typing"]
====

IMPORTANT: A runtime `KosonException` will be raised when a JSON key (attribute) duplicate is found in an _obj { }_

* A JSON value of an _obj { }_ or an _array [...]_ can be one of the following `Kotlin` or _Koson DSL_ instances
** `String`
** `Number`
** `Boolean`
** `Any` (will render using `.toString()`, escaping `"` chars)
** `null`
** _obj { }_
** _array[...]_
** _array_ (empty array)

== Runtime prerequisites

* `Kotlin`
* `Java` 8 or later

== Build prerequisites

* `Java` 8 or later

[source]
----
./mvnw package
----

== Benchmarks

Benchmarks have been conducted with the https://openjdk.java.net/projects/code-tools/jmh/[jmh] OpenJDK tool. Benchmark project can be found under `benchmarks` folder.

Two tests were done with the same objects and arrays

* Rendering a big object (String representation)
* Rendering a big array (String representation)

`Kson` was put side to side with one of the most popular JSON builder for `Java` : https://github.com/stleary/JSON-java[JSON-java]

Testing environment : _3.3 GHz Intel Core i5-6600, 4 cores, VM version: OpenJDK 11.0.1, 64-Bit Server VM, 11.0.1+13_

.Score in operations/second, higher = better
|===
|Benchmark  |Mode |Cnt |Score |Error |Units

|BigArray - JSON-java
|thrpt
|25
|16682,855
|± 111,508
|ops/s

|BigArray - Koson
|thrpt
|25
|17171,664
|± 125,906
|ops/s

|BigObject - JSON-java
|thrpt
|25
|18284,186
|± 137,600
|ops/s

|BigObject - Koson
|thrpt
|25
|20261,219
|± 424,912
|ops/s
|===

To run the tests locally with java 8 or later, do

[source]
----
cd benchmarks
mvn clean install
java -jar target/benchmarks.jar
----

